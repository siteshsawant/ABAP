METHOD IF_EX_NOTIF_EVENT_SAVE~CHANGE_DATA_AT_SAVE.
  DATA: LT_M1 TYPE ZSPM_MAILBODY.
  DATA: HEADER  TYPE STRING,
        HEADER1 TYPE STRING,
        HEADER2 TYPE STRING,
        FOOTER  TYPE STRING,
        FOOTER2 TYPE STRING,
        MESSAGE TYPE STRING,
        TEST    TYPE QMNUM,
        TO      TYPE T024I-SMTP_ADDR,
        DATE    TYPE STRING,
        TIME    TYPE STRING.
* Data Declarations
  DATA: LT_MAILSUBJECT     TYPE SODOCCHGI1.
  DATA: LT_MAILRECIPIENTS TYPE STANDARD TABLE OF SOMLREC90,
        WA_MAILRECIPIENTS TYPE SOMLREC90.
  DATA: LT_MAILTXT         TYPE STANDARD TABLE OF SOLI.
  DATA : LT_CONTENTS TYPE STANDARD TABLE OF SOLISTI1,
         WA_CONTENTS TYPE SOLISTI1.

  HEADER = 'Dear User,<br>'.
  HEADER2 = 'Please find the below details.'.
  FOOTER = 'Please access the Notification with IW22 or IW28 T Code in SAP using above Notification Number.'.
  FOOTER2 = 'Thank you'.
  LT_M1-QMNUM = CS_VIQMEL-QMNUM.
  LT_M1-QMTXT = CS_VIQMEL-QMTXT.
  LT_M1-SWERK = CS_VIQMEL-SWERK.
  LT_M1-EQUNR = CS_VIQMEL-EQUNR.
  SELECT SINGLE EQKTX FROM EQKT INTO LT_M1-EQKTX WHERE EQUNR = CS_VIQMEL-EQUNR AND SPRAS = 'EN'.
  LT_M1-TPLNR = CS_VIQMEL-TPLNR.
  SELECT SINGLE PLTXT FROM IFLOTX INTO LT_M1-PLTXT WHERE TPLNR = CS_VIQMEL-TPLNR AND SPRAS = 'EN'.
  LT_M1-QMNAM = CS_VIQMEL-QMNAM.
  CASE FLT_VAL.
    WHEN 'M1'.
      HEADER1 = '<BR> A Maintenance Request is raised. &nbsp;'.
      CONCATENATE HEADER LT_M1-QMNUM LT_M1-QMTXT INTO MESSAGE.
      "MESSAGE MESSAGE TYPE 'E'.
    WHEN 'M2'.
      CONCATENATE CS_VIQMEL-AUSVN+6(2) '/' CS_VIQMEL-AUSVN+4(2) '/' CS_VIQMEL-AUSVN+0(4) INTO DATE.
      CONCATENATE CS_VIQMEL-AUZTV+0(2) ':' CS_VIQMEL-AUZTV+2(2) ':' CS_VIQMEL-AUZTV+4(2) INTO TIME.
      HEADER1 = '<BR> A Malfunction Report is created. &nbsp;'.
      CONCATENATE HEADER LT_M1-QMNUM LT_M1-QMTXT INTO MESSAGE.
      "MESSAGE MESSAGE TYPE 'E'.
    WHEN OTHERS.
      SKIP.
  ENDCASE.

  SELECT SINGLE SMTP_ADDR FROM T024I INTO TO WHERE IWERK = CS_VIQMEL-IWERK AND INGRP = CS_VIQMEL-INGRP.
* Recipients
  WA_MAILRECIPIENTS-REC_TYPE  = 'U'.
  WA_MAILRECIPIENTS-RECEIVER = 'pm-notificaion-test@diageo.com'.
  APPEND WA_MAILRECIPIENTS TO LT_MAILRECIPIENTS .
  CLEAR WA_MAILRECIPIENTS .
*    WA_MAILRECIPIENTS-REC_TYPE  = 'U'.
*  WA_MAILRECIPIENTS-RECEIVER = 'Ameya.Joshi@diageo.com'.
*  APPEND WA_MAILRECIPIENTS TO LT_MAILRECIPIENTS .
*  CLEAR WA_MAILRECIPIENTS .
* Subject.
  IF FLT_VAL EQ 'M1'.
    CONCATENATE 'Maintenance Request - ' CS_VIQMEL-QMNUM INTO LT_MAILSUBJECT-OBJ_DESCR.
  ELSEIF FLT_VAL EQ 'M2'.
    CONCATENATE 'Malfunction Report - ' CS_VIQMEL-QMNUM INTO LT_MAILSUBJECT-OBJ_DESCR.
  ENDIF.


  CLEAR : LT_CONTENTS[].
  WA_CONTENTS-LINE = '<HTML><BODY>'.
  APPEND WA_CONTENTS TO LT_CONTENTS.
  CLEAR : WA_CONTENTS.

  CONCATENATE '<p style="font-family:Calibri;font-size:15;"></p>' HEADER HEADER1 HEADER2 '<BR> <BR>' INTO WA_CONTENTS-LINE SEPARATED BY SPACE.
  APPEND WA_CONTENTS TO LT_CONTENTS.
  CLEAR : WA_CONTENTS.

  WA_CONTENTS-LINE = '<table style="font-family:calibri;font-size:15;" bordercolor="blue";'.   .
  APPEND WA_CONTENTS TO LT_CONTENTS.
  CLEAR : WA_CONTENTS.

  WA_CONTENTS-LINE = 'cellspacing="0" cellpadding="1" width="60%" '.
  APPEND WA_CONTENTS TO LT_CONTENTS.
  CLEAR : WA_CONTENTS.

  WA_CONTENTS-LINE = 'border="1"><tbody>'.
  APPEND WA_CONTENTS TO LT_CONTENTS.
  CLEAR : WA_CONTENTS.

  CONCATENATE '<tr><td bgcolor="#COCOCO">&nbsp;&nbsp;Notification Number :</td>' '<td>&nbsp;&nbsp;' LT_M1-QMNUM '</td></tr><BR>' INTO WA_CONTENTS-LINE.
  APPEND WA_CONTENTS TO LT_CONTENTS.
  CLEAR : WA_CONTENTS.

  CONCATENATE '<tr><td bgcolor="#COCOCO">&nbsp;&nbsp;Notification Description :</td>' '<td>&nbsp;&nbsp;' LT_M1-QMTXT '</td></tr><BR>' INTO WA_CONTENTS-LINE.
  APPEND WA_CONTENTS TO LT_CONTENTS.
  CLEAR : WA_CONTENTS.

  CONCATENATE '<tr><td bgcolor="#COCOCO">&nbsp;&nbsp;Maintenance Plant :</td>' '<td>&nbsp;&nbsp;' LT_M1-SWERK '</td></tr><BR>' INTO WA_CONTENTS-LINE.
  APPEND WA_CONTENTS TO LT_CONTENTS.
  CLEAR : WA_CONTENTS.

  CONCATENATE '<tr><td bgcolor="#COCOCO">&nbsp;&nbsp;Equipment :</td>' '<td>&nbsp;&nbsp;' LT_M1-EQUNR '</td></tr><BR>' INTO WA_CONTENTS-LINE.
  APPEND WA_CONTENTS TO LT_CONTENTS.
  CLEAR : WA_CONTENTS.

  CONCATENATE '<tr><td bgcolor="#COCOCO">&nbsp;&nbsp;Equipment Description :</td>' '<td>&nbsp;&nbsp;' LT_M1-EQKTX '</td></tr><BR>' INTO WA_CONTENTS-LINE.
  APPEND WA_CONTENTS TO LT_CONTENTS.
  CLEAR : WA_CONTENTS.

  CONCATENATE '<tr><td bgcolor="#COCOCO">&nbsp;&nbsp;Functional Location :</td>' '<td>&nbsp;&nbsp;' LT_M1-TPLNR '</td></tr><BR>' INTO WA_CONTENTS-LINE.
  APPEND WA_CONTENTS TO LT_CONTENTS.
  CLEAR : WA_CONTENTS.

  CONCATENATE '<tr><td bgcolor="#COCOCO">&nbsp;&nbsp;Functional Location :</td>' '<td>&nbsp;&nbsp;' LT_M1-PLTXT '</td></tr><BR>' INTO WA_CONTENTS-LINE.
  APPEND WA_CONTENTS TO LT_CONTENTS.
  CLEAR : WA_CONTENTS.

  CONCATENATE '<tr><td bgcolor="#COCOCO" >&nbsp;&nbsp;Reported By :</td>' '<td>&nbsp;&nbsp;' LT_M1-QMNAM '</td></tr><BR>' INTO WA_CONTENTS-LINE.
  APPEND WA_CONTENTS TO LT_CONTENTS.
  CLEAR : WA_CONTENTS.

  IF FLT_VAL EQ 'M2'.
    CONCATENATE '<tr><td bgcolor="#COCOCO" >&nbsp;&nbsp;Breakdown Date :</td>' '<td>&nbsp;&nbsp;' DATE '</td></tr><BR>' INTO WA_CONTENTS-LINE.
    APPEND WA_CONTENTS TO LT_CONTENTS.
    CLEAR : WA_CONTENTS.

    CONCATENATE '<tr><td bgcolor="#COCOCO">&nbsp;&nbsp;Breakdown Time :</td>' '<td>&nbsp;&nbsp;' TIME '</td></tr><BR>' INTO WA_CONTENTS-LINE.
    APPEND WA_CONTENTS TO LT_CONTENTS.
    CLEAR : WA_CONTENTS.
  ENDIF.

  CONCATENATE '</tbody></table><br><p>' FOOTER '</p>' INTO WA_CONTENTS-LINE.
  APPEND WA_CONTENTS TO LT_CONTENTS.
  CLEAR : WA_CONTENTS.

  CONCATENATE '<p>' FOOTER2 '</p>' '<br>' INTO WA_CONTENTS-LINE.
  APPEND WA_CONTENTS TO LT_CONTENTS.
  CLEAR : WA_CONTENTS.

  WA_CONTENTS-LINE = '</BODY>'.
  APPEND WA_CONTENTS TO LT_CONTENTS.
  CLEAR : WA_CONTENTS.



  CALL FUNCTION 'SO_NEW_DOCUMENT_SEND_API1' DESTINATION 'NONE'
    EXPORTING
      DOCUMENT_DATA              = LT_MAILSUBJECT
      DOCUMENT_TYPE              = 'HTM'
      COMMIT_WORK                = 'X'
    TABLES
      OBJECT_CONTENT             = LT_CONTENTS
      RECEIVERS                  = LT_MAILRECIPIENTS
    EXCEPTIONS
      TOO_MANY_RECEIVERS         = 1
      DOCUMENT_NOT_SENT          = 2
      DOCUMENT_TYPE_NOT_EXIST    = 3
      OPERATION_NO_AUTHORIZATION = 4
      PARAMETER_ERROR            = 5
      X_ERROR                    = 6
      ENQUEUE_ERROR              = 7
      OTHERS                     = 8.

  SUBMIT RSCONN01 WITH MODE = 'INT' AND RETURN.



  CLEAR: LT_M1, HEADER, MESSAGE.
ENDMETHOD.
